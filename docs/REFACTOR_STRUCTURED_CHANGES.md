# Refactor: Structured Changes (No LLM Diffs)

## Overview

The CrewAI pipeline has been refactored to eliminate malformed diffs by:
1. **Removing LLM-generated diffs** - Agent no longer outputs diff format
2. **Using structured JSON changes** - Agent outputs file operations in JSON
3. **Direct file editing** - Changes applied directly to files
4. **Git-generated patches** - Patch always generated by `git diff` (guaranteed valid)

## What Changed

### Files Modified

1. **`automated_crew.py`** - Main pipeline script
   - Updated developer task prompt
   - Added structured changes parsing
   - Added direct file editing
   - Added git patch generation
   - Replaced diff extraction/application flow

### Key Functions Added

1. **`parse_structured_changes(text: str) -> dict`**
   - Parses JSON from agent output
   - Extracts structured changes
   - Returns error if parsing fails

2. **`validate_structured_changes(changes_data: dict, work_dir: Path) -> tuple[bool, list[str]]`**
   - Validates file paths exist (for replace/edit/delete)
   - Rejects diff-like content
   - Validates operation types
   - Returns validation errors

3. **`apply_structured_changes(changes_data: dict, work_dir: Path) -> tuple[bool, list[str], list[str]]`**
   - Applies changes directly to files
   - Supports: create, replace, edit, delete
   - Returns changed files and errors

4. **`generate_git_patch(work_dir: Path, patch_file: Path) -> tuple[bool, str]`**
   - Generates patch using `git diff --no-color --minimal`
   - Validates patch is non-empty
   - Optionally validates with `git apply --check`
   - Always produces valid unified diff format

## New Agent Output Schema

The developer agent now outputs **structured JSON** instead of a diff:

```json
{
  "changes": [
    {
      "path": "path/to/file.js",
      "operation": "replace",
      "content": "full file content here\nwith all lines"
    },
    {
      "path": "path/to/another.js",
      "operation": "edit",
      "edits": [
        {"find": "old code line", "replace": "new code line"},
        {"find": "another old", "replace": "another new"}
      ]
    },
    {
      "path": "new/file.js",
      "operation": "create",
      "content": "new file content"
    },
    {
      "path": "old/file.js",
      "operation": "delete"
    }
  ]
}
```

### Operations

- **`replace_file`** or **`replace`**: Replace entire file (provide full `content`)
- **`create`**: Create new file (provide full `content`)
- **`upsert_function_js`**: Upsert JavaScript function (replace if exists, append if not)
  - Requires: `function_name` and `content` (full function definition)
  - Supports: `function name()`, `const name = function()`, `const name = () =>`
- **`upsert_css_selector`**: Upsert CSS selector (replace if exists, append if not)
  - Requires: `selector` (e.g., ".modal", "#id") and `content` (full CSS block)
- **`insert_after_anchor`**: Insert content after anchor string/regex
  - Requires: `anchor`, `content`, optional `use_regex` (default: false)
- **`insert_before_anchor`**: Insert content before anchor string/regex
  - Requires: `anchor`, `content`, optional `use_regex` (default: false)
- **`append_if_missing`**: Append content only if signature not present
  - Requires: `content`, `signature` (substring to check for)
- **`edit`**: Make targeted edits with regex fallback (provide `edits` array with find/replace pairs)
- **`delete`**: Delete file (no content needed)

## Patch Generation

### Command Used

```bash
git diff --no-color --minimal > crewai_patch.diff
```

### Why This Works

- **Always valid**: Git generates proper unified diff format
- **No corruption**: No LLM parsing errors
- **Minimal changes**: `--minimal` flag ensures smallest diff
- **Standard format**: Compatible with all git tools

### Validation

1. **Non-empty check**: Patch must contain changes
2. **Format validation**: Optional `git apply --check` to verify
3. **File existence**: Files must exist before editing

### Patch Artifacts (NOT Committed)

- **`crewai_patch.diff`** is a **local artifact only**
- Generated for human review and debugging
- **NOT committed** to the repository
- Added to `.gitignore` to prevent accidental commits
- Implementation plans are also excluded from commits (reference only)

## Coverage Gate (Completion Gating)

### Coverage Check

Before committing or moving issues to Done, the system verifies:

1. **Required Functions** exist in JS files
2. **Required CSS Selectors** exist in styles.css
3. **Required Test Files** exist
4. **Required Files** exist

### Coverage Gate Behavior

**If coverage fails:**
- Status: `incomplete`
- Missing items checklist printed
- **DO NOT commit**
- **DO NOT push**
- **DO NOT move issue to Done**
- Retry mechanism triggered (up to 2 additional attempts)

**If coverage passes:**
- Status: `complete`
- Proceed with commit
- Generate patch via git diff
- Move issue to Done (if enabled)

## Guardrails

### 1. Reject Diff-Like Output

If agent output contains:
- `diff --git`
- `--- a/`
- `@@ -` (hunk headers)

The system will:
- Warn that output looks like a diff
- Attempt to parse as structured JSON anyway
- Fall back to legacy diff approach if needed

### 2. File Validation

Before applying changes:
- **Replace/Edit/Delete**: File must exist
- **Create**: Parent directory created if needed
- **Path validation**: Checks for similar files (case-insensitive)

### 3. Operation Validation

- Valid operations: `create`, `replace_file`, `replace`, `edit`, `upsert_function_js`, `upsert_css_selector`, `insert_after_anchor`, `insert_before_anchor`, `append_if_missing`, `delete`
- Required fields checked per operation
- Content/edits validated

### 4. Patch Artifacts Exclusion

- `crewai_patch.diff` and `*_patch.diff` are excluded from commits
- Implementation plans (`implementations/*.md`) are excluded from commits
- Only source files are committed

## Logging

### Console Output

```
======================================================================
üìù APPLYING STRUCTURED CHANGES
======================================================================
‚úì Created file: new/file.js
‚úì Replaced file: path/to/file.js
‚úì Edited file: path/to/another.js

‚úÖ Successfully applied changes to 3 file(s):
   - new/file.js
   - path/to/file.js
   - path/to/another.js

üì¶ Generating patch using git diff...
‚úÖ Patch generated successfully: crewai_patch.diff
   Files changed: 3
   Lines added: 45
   Lines removed: 12
   ‚úÖ Patch is non-empty and valid
```

### Implementation Plan File

The plan file now includes:

```markdown
## Structured Changes (JSON)

```json
{
  "changes": [...]
}
```

## Generated Patch (from git diff)

```diff
diff --git a/file.js b/file.js
index abc123..def456 100644
--- a/file.js
+++ b/file.js
@@ -1,3 +1,5 @@
 function example() {
+  // new code
   return true;
 }
```

‚úÖ **Note:** This patch was generated by `git diff` and is guaranteed to be valid.
```

## Benefits

### 1. No Malformed Diffs

- **Before**: LLM-generated diffs often corrupted
- **After**: Git-generated diffs always valid

### 2. Deterministic

- **Before**: Diff format varied, parsing unreliable
- **After**: Git diff format is standard and consistent

### 3. Better Error Handling

- **Before**: Diff parsing failures hard to debug
- **After**: JSON parsing errors are clear and actionable

### 4. Safer Changes

- **Before**: Large diffs could corrupt files
- **After**: Direct file editing with validation

## Backward Compatibility

The system includes a **fallback** to legacy diff approach:
- If structured changes parsing fails
- If agent outputs diff format (old behavior)
- System attempts to apply legacy diff

This ensures existing workflows continue to work.

## Testing

To verify the refactor works:

1. **Run the crew** on an issue
2. **Check console output** for structured changes messages
3. **Verify patch file** is generated by git diff
4. **Check patch format** - should be valid unified diff
5. **Review implementation plan** - should contain JSON and git-generated patch

## Example Flow

1. Agent outputs JSON with structured changes
2. System validates changes (files exist, operations valid)
3. System applies changes directly to files
4. System runs `git diff` to generate patch
5. System validates patch (non-empty, valid format)
6. System saves patch to `crewai_patch.diff`
7. Tests run (if configured)
8. Summary shows files changed, lines added/removed

## Completion Gating

### Coverage Gate

Before committing or moving issues to Done, the system verifies:

1. **Required Functions** exist in JS files (from plan's "New Functions" section)
2. **Required CSS Selectors** exist in styles.css (from plan's CSS mentions)
3. **Required Test Files** exist (from plan's "Test Approach" section)
4. **Required Files** exist (from plan's "Files to Change" section)

### Gate Behavior

**If coverage fails:**
- Status: `incomplete`
- Missing items checklist printed
- **DO NOT commit**
- **DO NOT push**
- **DO NOT move issue to Done**
- Automatic retry triggered (up to 2 additional attempts)

**If coverage passes:**
- Status: `complete`
- Proceed with commit (only source files, excluding patch artifacts)
- Generate patch via git diff (local artifact, not committed)
- Move issue to Done (if enabled)

## Patch Artifacts (NOT Committed)

- **`crewai_patch.diff`** is a **local artifact only**
- Generated for human review and debugging
- **NOT committed** to the repository
- Added to `.gitignore` to prevent accidental commits
- Implementation plans (`implementations/*.md`) are also excluded from commits

## Self-Tests

The code includes self-test functions for validation:

- `test_upsert_function_js()` - Tests function upsert logic
- `test_upsert_css_selector()` - Tests CSS selector upsert logic

Run tests with:
```bash
TEST_MODE=true python scripts/automated_crew.py
```

## Confirmation

‚úÖ **Malformed diffs are no longer possible** because:
- Agent doesn't output diffs (outputs JSON)
- Patch is always generated by Git
- Git diff format is guaranteed valid
- Validation ensures patch is non-empty and correct

‚úÖ **Partial implementations are prevented** because:
- Coverage gate checks all requirements
- Status is `incomplete` if any requirement missing
- No commit/Done operations if incomplete
- Automatic retry fixes missing items

‚úÖ **Patch artifacts are not committed** because:
- `.gitignore` excludes `crewai_patch.diff` and `*_patch.diff`
- Git add explicitly filters out patch files
- Only source files are staged and committed
